#!/bin/sh

# set -o xtrace
# set -o errexit
set -o posix
set -o nounset
set -o pipefail

HNAME=$(hostname)
echo "Status: Hostname $HNAME"

XPATH=$(realpath "$0")
echo "Status: Path $XPATH"

DPATH=$(dirname "$XPATH")
echo "Status: Dir $DPATH"

onroot () {
  if [ "$(echo "$1" | cut -c -6)" = "/home/" ]; then
    return 10
  else
    return 11
  fi
}

dosudo () {
  onroot "$2"

  if [ $? = 11 ]; then
    $SHELL -c "sudo $1 $2"
  else
    $SHELL -c "$1 $2"
  fi
}

cmerge () {
  SRC="$1"                              # source
  HSRC="$SRC.$HNAME"                    # host-specific source
  DST="$2"                              # destination

  if [ -f "$SRC" ]; then
    # common
    # echo "Status: Found $PSRC -> $DST"
    SRC="$SRC"
  elif [ -f "$HSRC" ]; then
    # host-specific
    # echo "Status: Found $PHSRC -> $DST"
    SRC="$HSRC"
  else
    echo "Might-Skip:"
    echo "  $DPATH/$SRC does not exist"
    echo "  $DPATH/$HSRC does not exist"

    if [ -f "$DST" ]; then
      echo "Not-Skip: $DST -> {$HSRC}"
      cp -i "$DST" "$DPATH/$HSRC"
    else
      echo "Skip: File $DST does not exist either"
    fi

    return
  fi

  if [ -e "$DST" ]; then
    if [ -f "$DST" ]; then
      if diff "$DPATH/$SRC" "$DST" 1>/dev/null 2>&1 ; then
	echo "Skip: {$SRC} === $DST"
      else
	echo "Merge: {$SRC} != $DST"
	dosudo "vim -f -d $DPATH/$SRC" "$DST"
      fi
    else
      echo "Error: $DST exists but is not a file"
      exit 1
    fi
  else
    DSTDIRNAME=$(dirname "$DST")
    echo "Create: $DSTDIRNAME"
    dosudo "mkdir -p" "$DSTDIRNAME"
    echo "Copy: {$SRC} -> $DST"
    dosudo "cp -i $DPATH/$SRC" "$DST"
  fi
}

cmerge xfce4/displays.xml                  ~/.config/xfce4/xfconf/xfce-perchannel-xml/displays.xml
cmerge xfce4/keyboard-layout.xml           ~/.config/xfce4/xfconf/xfce-perchannel-xml/keyboard-layout.xml
cmerge xfce4/keyboards.xml                 ~/.config/xfce4/xfconf/xfce-perchannel-xml/keyboards.xml
cmerge xfce4/pointers.xml                  ~/.config/xfce4/xfconf/xfce-perchannel-xml/pointers.xml
cmerge xfce4/thunar.xml                    ~/.config/xfce4/xfconf/xfce-perchannel-xml/thunar.xml
cmerge xfce4/xfce4-appfinder.xml           ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-appfinder.xml
cmerge xfce4/xfce4-desktop.xml             ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml
cmerge xfce4/xfce4-keyboard-shortcuts.xml  ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-keyboard-shortcuts.xml
cmerge xfce4/xfce4-notifyd.xml             ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-notifyd.xml
cmerge xfce4/xfce4-panel.xml               ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-panel.xml
cmerge xfce4/xfce4-power-manager.xml       ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-power-manager.xml
cmerge xfce4/xfce4-session.xml             ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml
cmerge xfce4/xfce4-settings-editor.xml     ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-settings-editor.xml
cmerge xfce4/xfce4-settings-manager.xml    ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-settings-manager.xml
cmerge xfce4/xfwm4.xml                     ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml
cmerge xfce4/xsettings.xml                 ~/.config/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml
cmerge xfce4/terminalrrc                   ~/.config/xfce4/terminal/terminalrc

cmerge autostart/redshift.desktop     ~/.config/autostart/redshift.desktop
cmerge autostart/notifyd.desktop      ~/.config/autostart/notifyd.desktop
cmerge autostart/xrgb-dp1-3.desktop   ~/.config/autostart/xrgb-dp1-3.desktop
cmerge autostart/xrgb-dp3.desktop     ~/.config/autostart/xrgb-dp3.desktop
cmerge autostart/xnocaps.desktop      ~/.config/autostart/xnocaps.desktop

cmerge applications/Zoom.desktop      ~/.local/share/applications/Zoom.desktop
cmerge applications/Eclipse.desktop   ~/.local/share/applications/Eclipse.desktop

cmerge bashrc                         ~/.bashrc
cmerge bash_profile                   ~/.bash_profile
cmerge gtk/gtkrc-2.0                  ~/.gtkrc-2.0
cmerge gtk/filechooser.ini            ~/.config/gtk-2.0/gtkfilechooser.ini
cmerge emacs/emacs.el                 ~/.config/emacs/init
cmerge fonts.conf                     ~/.config/fontconfig/fonts.conf
cmerge gitconfig                      ~/.gitconfig
cmerge htoprc                         ~/.config/htop/htoprc
cmerge hunspell_en_US                 ~/.hunspell_en_US
cmerge profile                        ~/.profile
cmerge redshift.conf                  ~/.config/redshift.conf
cmerge vimrc                          ~/.vimrc
cmerge youtube-dl.conf                ~/.config/youtube-dl/config

cmerge x11/dmrc                       ~/.dmrc
cmerge x11/lightdm.conf               /etc/lightdm/lightdm.conf

cmerge loader/loader.conf             /boot/loader/loader.conf
cmerge loader/arch.conf               /boot/loader/entries/arch.conf

cmerge nvidia/nvidia-settings         ~/.nvidia-settings-rc
cmerge nvidia/optimus-manager.conf    /etc/optimus-manager/optimus-manager.conf
cmerge nvidia/optimus-xorg.conf       /etc/optimus-manager/xorg-nvidia.conf

cmerge systemd/coredump.conf          /etc/systemd/coredump.conf
cmerge systemd/system.conf            /etc/systemd/system.conf

cmerge archlinux/makepkg.conf         /etc/makepkg.conf
cmerge archlinux/mkinitcpio.conf      /etc/mkinitcpio.conf
cmerge archlinux/pacman.conf          /etc/pacman.conf

cmerge hostname                       /etc/hostname
cmerge hosts                          /etc/hosts
cmerge locale.conf                    /etc/locale.conf
cmerge vconsole.conf                  /etc/vconsole.conf
cmerge sysctl.conf                    /etc/sysctl.d/sysctl.conf

if [ -f /etc/os-release ]; then
  if grep -i "archlinux" /etc/os-release 1>/dev/null 2>&1 ; then
    pkgs_tmp_file=$(mktemp)
    pacman -Qtte | awk '{ print $1 }' > "$pkgs_tmp_file"
    cmerge pkgs.list "$pkgs_tmp_file"

    pkgs_install=""

    while read -r pkg ; do
      if ! grep "$pkg" "$pkgs_tmp_file" 1>/dev/null 2>&1 ; then
        echo "Install: $pkg"
        pkgs_install="$pkg $pkgs_install"
      fi
    done < "pkgs.list"

    pkgs_remove=""

    while read -r pkg ; do
      if ! grep "$pkg" "pkgs.list" 1>/dev/null 2>&1 ; then
        echo "Remove: $pkg"
        pkgs_remove="$pkg $pkgs_remove"
      fi
    done < "$pkgs_tmp_file"

    rm "$pkgs_tmp_file"

    if [ "$pkgs_remove" != "" ]; then
      echo "Remove Packages:"
      $SHELL -c "sudo pacman -Rcsn $pkgs_remove"
    fi

    echo "Update System"
    $SHELL -c "yay"

    if [ "$pkgs_install" != "" ]; then
      echo "Install Packages:"
      $SHELL -c "sudo pacman -S --needed $pkgs_install"
    fi
  fi
fi
